# Windows forwarding events
Скрипт для настройки машины для WinEventLog или пересылки событий на WEC. Пересылка событий на WEC (работает только если машины в домене). Протестировано на MP SIEM.

Так как скрипт использует русские буквы, необходимо проверить его кодировку. Она должна быть юникод.

**Примечание:** скрипт работает корректно если предварительно средствами ОС создана (уже имеется) учетная запись локального пользователя ОС для доступа MP 10 Collector.
Данные этой учетной записи нужно указать при добавлении учетной записи в MaxPatrol 10.  Учетная запись добавлена в локальную (групповую) политику безопасности «Доступ к компьютеру из сети» (Access this computer from the network).


<b>Для корректной работы скрипта нужно заполнить данные.</b> 
# Описание входных данных

<b> Адрес Windows Event Collector. Необходим настройки для пересылки на WEC</b> 

$serverAddress = "wec.local.dom"

<b> Имя учетной записи для MP 10 Collector. С ее помощью Collector (agent) будет собирать логи. Дан­ные этой учет­ной за­пи­си нуж­но ука­зать при до­бав­ле­нии учет­ной за­пи­си в MaxPatrol SIEM.</b> 

$mp10collector = 'Администратор' 

<b> Интервал обновления подписки. Измеряется в секундах.</b> 

$refreshInterval = 600           
# Описание

<b>1. Настройка политики аудита с помощью утилиты auditpol</b>
<br>
Подробнее о всех параметрах аудита можно ознакомиться по ссылке: https://help.ptsecurity.com/ru-RU/projects/mp10/27.2/help/1083632139

auditpol /set /subcategory:"{0CCE9241-69AE-11D9-BED3-505054503030}" /success:disable /failure:enable
	
название категории и подкатегории указаны в виде GUID. Чтобы посмотреть список всех GUID для аудита, можно воспользоваться командой:<br>
auditpol /list /subcategory:* /v 
<br>
<br>
<br>
<b> 2. Настройка службы WinRM</b><br>
winrm quickconfig -q <br>
И немного проверки на работоспособность службы.
<br>
<br>
<br>
<b> 3. Включение правил межсетевого экрана для удаленного управления журналом событий</b> <br>
После включение автонастройки службы WinRM, в брандмауре создается правило, которое открывает порт 5985. Нужно проверить, точно ли порт открыт. Если открыт, то пропускается создание, если нет, то добавляется новое 
<br>
<br>
<br>
<b> 4. Настройка пересылки событий на WEC </b><br>
Если ранее было дано подтверждение для этого действия, то добавляется в реестр запись с информацией по пересылке событий (с введенным выше адресом wec), ну и разрешается доступ до журнала Security.<br>
Если пользователь отказался, то включаются дополнительно правила бранмауэра и доступ до журнала Security для учетной записи MP 10 Collector. Необходимо заранее создать такую учетную запись на машине. <br>
Подробнее : https://help.ptsecurity.com/ru-RU/projects/mp10/27.2/help/1109335563
<br>
<br>
<br>
Дополнительно, если запускать в ISE, консоль может выдавать брэд. Чтобы исправить кодировку в консоли, можно воспользоваться одной из этих команд:<br>
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

[Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding("utf-8")

[Console]::outputEncoding = [System.Text.Encoding]::GetEncoding('cp866')
